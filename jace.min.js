function Coordinates(a,b){this.x=a;this.y=b}Coordinates.prototype.move=function(a,b){this.x+=a;this.y+=b};
var resources={files:{},add:function(a,b){this.done=!1;this.files[a]={};this.files[a].loaded=!1;this.files[a].path=b},loadAll:function(a){for(var b in this.files)this.getJSON(this.files[b].path,b,a)},retrieve:function(a){if(!this.files[a].loaded)throw"cannot resources.retrieve("+a+") without doing resources.loadAll() first";return this.files[a].value},onload:function(a){console.log("loaded "+a)},getJSON:function(a,b,c){var d;d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");
d.onreadystatechange=function(){4==d.readyState&&200==d.status&&(resources.onload(resources.files[b].path),resources.files[b].value=d.responseText,resources.files[b].loaded=!0,resources.doneLoading()&&c())};d.open("GET",a,!0);d.send()},doneLoading:function(){for(var a in this.files)if(!this.files[a].loaded)return!1;return!0}};function KeyPress(a){this.key=a;this.presstime=0}
function Drawable(a,b,c){this.position=new Coordinates(a,b);if("undefined"==c)throw"Drawable constructor's layer parameter cannot be undefined";this.layer=c}Drawable.prototype.tick=function(){console.log("ERROR: CALLING Drawable.tick WITHOUT USING INHERITANCE")};Drawable.prototype.draw=function(){console.log("ERROR: CALLING Drawable.draw WITHOUT USING INHERITANCE")};function Frame(a,b){this.img=a;this.pause=Math.round(b/engine.tickrate)}function Animation(a){this.frames=a;this.reset()}
Animation.prototype.tick=function(){if(this.playing){if(0>=this.currpause--){if(++this.currframe==this.frames.length)return this.reset(),!0;this.currpause=this.frames[this.currframe].pause;return!0}return!1}};Animation.prototype.getCurrentImage=function(){return this.frames[this.currframe].img};Animation.prototype.getLastImage=function(){return this.frames[this.lastframe].img};
Animation.prototype.reset=function(){this.currpause=this.frames[0].pause;this.currframe=0;this.playing=!1;this.lastframe=0};Animation.prototype.isPlaying=function(){return this.playing};Animation.prototype.play=function(){this.playing=!0};Animation.prototype.draw=function(a,b){this.getLastImage().clear(a,b);this.getCurrentImage().draw(a,b);this.lastframe=this.currframe};function AtlasImage(a,b,c,d,e){this.atlas=new AtlasDefinition(b,c,d,e);this.img=a;this.center=new Coordinates(d/2,e/2)}
AtlasImage.prototype.draw=function(a,b){engine.context.drawImage(this.img,this.atlas.atlasx,this.atlas.atlasy,this.atlas.imgwidth,this.atlas.imgheight,a-this.center.x,b-this.center.y,this.atlas.imgwidth,this.atlas.imgheight)};AtlasImage.prototype.clear=function(a,b){engine.context.clearRect(a-this.center.x,b-this.center.y,this.atlas.imgwidth,this.atlas.imgheight)};function AtlasDefinition(a,b,c,d){this.atlasx=a;this.atlasy=b;this.imgwidth=c;this.imgheight=d}function Renderer(){this.drawables=[]}
Renderer.prototype.add=function(a){this.drawables.push(a);this.drawables.sort(function(a,c){return a.layer-c.layer})};Renderer.prototype.render=function(){for(var a=0;a<this.drawables.length;a++)this.drawables[a].draw()};window.performance=window.performance||{};performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();
var engine={height:"",width:"",context:"",canvas:"",tickthread:"",renderthread:"",renderer:"",objects:[],Engine:function(a,b,c,d,e){this.tickrate=b;this.framerate=1E3/c;this.canvas=document.getElementById(a);this.height=e;this.width=d;this.canvas.height=this.height;this.canvas.width=this.width;this.context=this.canvas.getContext("2d");this.canvas.setAttribute("tabindex","0");this.canvas.focus();this.renderer=new Renderer},start:function(){this.tickthread=setInterval("engine.tick()",this.tickrate);
this.renderthread=setInterval("engine.draw()",this.framerate)},stop:function(){clearInterval(tickthread);clearInterval(this.renderthread)},addDrawable:function(a){this.objects.push(a);this.renderer.add(a)},tick:function(){for(var a=0;a<engine.objects.length;a++)engine.objects[a].tick()},draw:function(){this.renderer.render()},drawdebug:function(a,b,c){console.log("draw operation: "+a.img.src+" - atlas("+a.atlas.atlasx+","+a.atlas.atlasy+") height("+a.atlas.imgwidth+","+a.atlas.imgheight+") position("+
b+","+c+")")}};function KeyInputController(a){this.keys=a}KeyInputController.prototype.getKeyState=function(a){if(!this.keys[a])throw"KeyInputController could not find key with ID "+a;return this.keys[a].presstime};KeyInputController.prototype.handleKeyDown=function(a){"undefined"!=typeof this.keys[a.keyCode]&&(this.keys[a.keyCode].presstime=window.performance.now())};KeyInputController.prototype.handleKeyUp=function(a){this.keys[a.keyCode]&&(this.keys[a.keyCode].presstime=0)};
KeyInputController.prototype.startListener=function(){var a=this;this.kd=function(b){a.handleKeyDown(b)};this.ku=function(b){a.handleKeyUp(b)};engine.canvas.addEventListener("keydown",this.kd,!1);engine.canvas.addEventListener("keyup",this.ku,!1)};
